@model InventoryManagementApp.ViewModels.InventoryViewModels.InventoryCreateViewModel

@{
    ViewData["Title"] = "Create Inventory";
}

<h2>Create Inventory</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

    <div class="tab-container">
        <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">Settings</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="customid-tab" data-bs-toggle="tab" data-bs-target="#customid" type="button">Custom ID</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="fields-tab" data-bs-toggle="tab" data-bs-target="#fields" type="button">Fields</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#access" type="button">Access</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button">Items</button>
            </li>
        </ul>

        <div class="tab-content p-3 border border-top-0" id="inventoryTabsContent">
            @await Html.PartialAsync("CreateTabs/_Settings", Model)
            @await Html.PartialAsync("CreateTabs/_CustomId", Model)
            @await Html.PartialAsync("CreateTabs/_Fields", Model)
            @await Html.PartialAsync("CreateTabs/_Access", Model)
            <div class="tab-pane fade @((ViewBag.ActiveTab == "items") ? "show active" : "")" id="items">
                @await Html.PartialAsync("~/Views/Inventory/CreateTabs/_Items.cshtml", Model)
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Save Inventory</button>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var activeTab = '@ViewBag.ActiveTab';
            if (activeTab) {
                var tab = new bootstrap.Tab(document.querySelector(`#${activeTab}-tab`));
                tab.show();
            }

            console.log("Items script loaded. jQuery available:", typeof $ === "function");

            $(document).on('click', '#btnAddItem', function (e) {
                e.preventDefault();
                var inventoryId = $(this).data('inventory-id');
                console.log("Add Item clicked, inventoryId=", inventoryId);

                $('#addItemFormContainer').load('/Inventory/GetAddItemForm?inventoryId=' + inventoryId, function (response, status, xhr) {
                    console.log("load callback status:", status);
                    if (status === "error") {
                        console.error("Error loading add-item form:", xhr.status, xhr.statusText);
                        alert("Error check the console (network / console).");
                    } else {
                        var itemsTab = document.querySelector('#items-tab');
                        if (itemsTab) {
                            try { new bootstrap.Tab(itemsTab).show(); } catch (e) { }
                        }
                    }
                });
            });

            $(document).on('submit', '#addItemForm', function (e) {
                e.preventDefault();
                var $form = $(this);
                console.log("Submitting addItemForm, action:", $form.attr('action'));

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    success: function (result) {
                        console.log("AddItem AJAX success");
                        $('#itemListContainer').html(result);
                        $('#addItemFormContainer').empty();
                    },
                    error: function (xhr, status, err) {
                        console.error("AddItem AJAX error:", status, err, xhr);
                        alert('Error adding item. Check console/network for details.');
                    }
                });
            });
        });
    </script>
}
