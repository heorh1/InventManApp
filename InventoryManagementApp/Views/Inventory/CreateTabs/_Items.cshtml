@model InventoryManagementApp.ViewModels.Inventory.InventoryCreateViewModel

@{
    var inventory = ViewData["Inventory"] as InventoryManagementApp.Models.Inventory;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Items</h5>

    @if (inventory == null)
    {
        <div class="alert alert-warning mb-0">
            ⚠️ Create or save the inventory first to manage items.
        </div>
    }
    else
    {
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
            ➕ Add Item
        </button>
    }
</div>

@if (inventory != null)
{
    <div id="itemsTableContainer">
        @await Html.PartialAsync("~/Views/InventoryItems/_ItemsTable.cshtml", inventory.Items, new ViewDataDictionary(ViewData) { { "Inventory", inventory } })
    </div>

    @await Html.PartialAsync("~/Views/InventoryItems/_AddItemModal.cshtml", new InventoryManagementApp.Models.InventoryItem
    {
        InventoryId = inventory.Id
    }, new ViewDataDictionary(ViewData) { { "Inventory", inventory } })
}
else
{
    <p class="text-muted mt-3">Once you create and save the inventory, you’ll be able to manage items here.</p>
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modalForm = document.querySelector("#addItemModal form");
            if (!modalForm) return;

            modalForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                try {
                    const response = await fetch(form.action, { method: "POST", body: formData });
                    if (!response.ok) return alert("Failed to add item.");

                    const html = await response.text();
                    document.querySelector("#itemsTableContainer").innerHTML = html;

                    bootstrap.Modal.getInstance(document.getElementById("addItemModal")).hide();
                    form.reset();
                } catch {
                    alert("Error while adding item.");
                }
            });
        });
    </script>
}
